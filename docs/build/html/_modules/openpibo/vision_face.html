

<!DOCTYPE html>
<html class="writer-html5" lang="ko" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>openpibo.vision_face &mdash; OPENPIBO 0.9.3.2 문서</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/mycss.css?v=f3e80786" />

  
    <link rel="shortcut icon" href="../../_static/icon.png"/>
    <link rel="canonical" href="https://themakerrobot.github.io/openpibo-python.pibrain/_modules/openpibo/_modules/openpibo/vision_face.html" />
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=976c6c6c"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/translations.js?v=afa94a99"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="색인" href="../../genindex.html" />
    <link rel="search" title="검색" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            OPENPIBO
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notes/piboMaker.html">파이보 메이커</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/software.html">소프트웨어</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/hardware.html">하드웨어</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Block</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../blocks/guide.html">블록코딩</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/audio.html">audio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/collect.html">collect</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/device.html">device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/usb_uart.html">usb_uart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/motion.html">motion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/oled.html">oled</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/pibo_graphics.html">pibo_graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/speech.html">speech</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/vision_camera.html">vision_camera</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/vision_detect.html">vision_detect</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/vision_face.html">vision_face</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/vision_classify.html">vision_classify</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../libraries/utils.html">utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OPENPIBO</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">모듈 코드</a></li>
      <li class="breadcrumb-item active">openpibo.vision_face</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>openpibo.vision_face의 소스 코드</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">영상처리, 인공지능 비전 기술을 사용합니다.</span>

<span class="sd">Class:</span>
<span class="sd">:meth:`~openpibo.vision_detect.putTextPIL`</span>
<span class="sd">:obj:`~openpibo.vision_detect.Face`</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">cv2</span><span class="o">,</span><span class="nn">dlib</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">pickle</span><span class="o">,</span><span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">mediapipe</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">mediapipe.tasks</span> <span class="kn">import</span> <span class="n">python</span> <span class="k">as</span> <span class="n">mp_python</span>
<span class="kn">from</span> <span class="nn">mediapipe.tasks.python</span> <span class="kn">import</span> <span class="n">vision</span> <span class="k">as</span> <span class="n">mp_vision</span>
<span class="kn">from</span> <span class="nn">openvino.runtime</span> <span class="kn">import</span> <span class="n">Core</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span><span class="n">ImageDraw</span><span class="p">,</span><span class="n">ImageFont</span>
<span class="kn">import</span> <span class="nn">openpibo_dlib_models</span>
<span class="kn">import</span> <span class="nn">openpibo_models</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3&#39;</span>  <span class="c1"># TensorFlow C++ 로그 제거</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LIBCAMERA_LOG_LEVELS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3&#39;</span>

<span class="c1"># ✅ 추가: TensorFlow 내부 디버그 메시지 완전 차단</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ultralytics&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<div class="viewcode-block" id="putTextPIL">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.putTextPIL">[문서]</a>
<span class="k">def</span> <span class="nf">putTextPIL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">)):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  이미지에 문자를 입력합니다. (한/영 가능 - pillow 이용)- COPY</span>

<span class="sd">  :param numpy.ndarray img: 이미지 객체</span>
<span class="sd">  :param str text: 표시할 문자열</span>
<span class="sd">  :param tuple(int, int) points: 텍스트 블록 좌측상단 좌표 (x, y)</span>
<span class="sd">  :param int size: 표시할 글자의 크기</span>
<span class="sd">  :param tuple(int, int, int) colors: 글자 색깔 RGB 값 (b, g, r) or 16진수 값 &#39;#ffffff&#39;</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;img&quot; must be image data from opencv&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">points</span><span class="si">}</span><span class="s1">&quot; must be tuple type&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;len(</span><span class="si">{</span><span class="n">points</span><span class="si">}</span><span class="s1">) must be 2&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="mi">16</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">))</span>

  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">colors</span><span class="si">}</span><span class="s1">&quot; must be tuple type&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;len(</span><span class="si">{</span><span class="n">colors</span><span class="si">}</span><span class="s1">) must be 3&#39;</span><span class="p">)</span>

  <span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="n">openpibo_models</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="s2">&quot;KDL.ttf&quot;</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
  <span class="n">pil</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>  <span class="c1"># CV to PIL</span>
  <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">pil</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>  <span class="c1"># putText</span>
  <span class="n">img</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pil</span><span class="p">)</span>  <span class="c1"># PIL to CV</span>
  <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="Face">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face">[문서]</a>
<span class="k">class</span> <span class="nc">Face</span><span class="p">:</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions:</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.detect`</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.get_ageGender`</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.get_age`</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.get_gender`</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.init_db`</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.train_face`</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.delete_face`</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.recognize`</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.get_db`</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.save_db`</span>
<span class="sd">:meth:`~openpibo.vision_detect.Face.load_db`</span>

<span class="sd">  얼굴과 관련된 다양한 기능을 수행하는 클래스입니다. 다음 기능을 수행할 수 있습니다.</span>

<span class="sd">  * 얼굴을 탐색합니다.</span>
<span class="sd">  * 얼굴을 학습/저장/삭제합니다.</span>
<span class="sd">  * 학습된 얼굴을 인식합니다.</span>
<span class="sd">  * 얼굴로 나이/성별/감정을 추정합니다.</span>

<span class="sd">  :얼굴 데이터베이스: 인스턴스 변수 **facedb** 를 의미하며, 여기에서 얼굴 데이터를 등록하고 불러오고 삭제합니다.</span>

<span class="sd">    얼굴 데이터베이스의 포맷은 이중 list ``[[], []]`` 이며, 첫 번째 list에는 얼굴의 이름이, 두 번째 list에는 학습된 얼굴 데이터가 인코딩되어 들어갑니다.</span>

<span class="sd">    또한 파일로 저장하여 인스턴스가 삭제된 후에도 얼굴 정보를 남겨둘 수 있습니다.</span>

<span class="sd">  example::</span>

<span class="sd">    from openpibo.vision_detect import Face</span>

<span class="sd">    face = Face()</span>
<span class="sd">    # 아래의 모든 예제 이전에 위 코드를 먼저 사용합니다.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span> <span class="o">=</span> <span class="p">[[],[]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="c1"># self.face_detector = dlib.get_frontal_face_detector()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">shape_predictor</span><span class="p">(</span><span class="n">openpibo_dlib_models</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="s2">&quot;shape_predictor_68_face_landmarks.dat&quot;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">face_encoder</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">face_recognition_model_v1</span><span class="p">(</span><span class="n">openpibo_dlib_models</span><span class="o">.</span><span class="n">filepath</span><span class="p">(</span><span class="s2">&quot;dlib_face_recognition_resnet_model_v1.dat&quot;</span><span class="p">))</span>

    <span class="c1"># Load OpenVINO models</span>
    <span class="n">ie</span> <span class="o">=</span> <span class="n">Core</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">face_detection_compiled</span> <span class="o">=</span> <span class="n">ie</span><span class="o">.</span><span class="n">compile_model</span><span class="p">(</span><span class="n">ie</span><span class="o">.</span><span class="n">read_model</span><span class="p">(</span><span class="s2">&quot;/home/pi/.model/face/detection/face-detection-retail-0004.xml&quot;</span><span class="p">),</span> <span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">age_gender_compiled</span> <span class="o">=</span> <span class="n">ie</span><span class="o">.</span><span class="n">compile_model</span><span class="p">(</span><span class="n">ie</span><span class="o">.</span><span class="n">read_model</span><span class="p">(</span><span class="s2">&quot;/home/pi/.model/face/age-gender/age-gender-recognition-retail-0013.xml&quot;</span><span class="p">),</span> <span class="s2">&quot;CPU&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">emotion_compiled</span> <span class="o">=</span> <span class="n">ie</span><span class="o">.</span><span class="n">compile_model</span><span class="p">(</span><span class="n">ie</span><span class="o">.</span><span class="n">read_model</span><span class="p">(</span><span class="s2">&quot;/home/pi/.model/face/emotion/emotions-recognition-retail-0003.xml&quot;</span><span class="p">),</span> <span class="s2">&quot;CPU&quot;</span><span class="p">)</span>

    <span class="c1"># Get input and output names for models</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">face_output_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_detection_compiled</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gender_output_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_gender_compiled</span><span class="o">.</span><span class="n">outputs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">any_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">age_output_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">age_gender_compiled</span><span class="o">.</span><span class="n">outputs</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">any_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">emotion_output_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emotion_compiled</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">emotions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;neutral&#39;</span><span class="p">,</span> <span class="s1">&#39;happy&#39;</span><span class="p">,</span> <span class="s1">&#39;sad&#39;</span><span class="p">,</span> <span class="s1">&#39;surprise&#39;</span><span class="p">,</span> <span class="s1">&#39;anger&#39;</span><span class="p">]</span>

    <span class="c1"># mediapipe model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mesh_detector</span> <span class="o">=</span> <span class="n">mp_vision</span><span class="o">.</span><span class="n">FaceLandmarker</span><span class="o">.</span><span class="n">create_from_options</span><span class="p">(</span>
      <span class="n">mp_vision</span><span class="o">.</span><span class="n">FaceLandmarkerOptions</span><span class="p">(</span>
        <span class="n">base_options</span><span class="o">=</span><span class="n">mp_python</span><span class="o">.</span><span class="n">BaseOptions</span><span class="p">(</span><span class="n">model_asset_path</span><span class="o">=</span><span class="s1">&#39;/home/pi/.model/face/landmark/face_landmarker.task&#39;</span><span class="p">),</span>
        <span class="n">running_mode</span><span class="o">=</span><span class="n">mp_vision</span><span class="o">.</span><span class="n">RunningMode</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span>
        <span class="n">num_faces</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">min_face_detection_confidence</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">min_face_presence_confidence</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">min_tracking_confidence</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">output_face_blendshapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">IRIS_REAL_DIAMETER_MM</span> <span class="o">=</span> <span class="mf">11.7</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">FOCAL_LENGTH_MM</span> <span class="o">=</span> <span class="mf">3.6</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">PIXEL_PITCH_MM</span> <span class="o">=</span> <span class="mf">0.0014</span> <span class="o">*</span> <span class="mi">2592</span> <span class="o">/</span> <span class="mi">640</span>


<div class="viewcode-block" id="Face.detect_face">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.detect_face">[문서]</a>
  <span class="k">def</span> <span class="nf">detect_face</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴을 탐색합니다.</span>

<span class="sd">    example::</span>

<span class="sd">      img = camera.read()</span>
<span class="sd">      face.detect_face(img)</span>

<span class="sd">    :param numpy.ndarray img: 이미지 객체</span>

<span class="sd">    :returns: 인식된 얼굴들의 (x, y, w, h) 배열 입니다.</span>

<span class="sd">      list 타입으로, 이미지 하나에 얼굴이 여러 개 인식된 경우 인식된 얼굴의 좌표가 모두 입력됩니다.</span>

<span class="sd">      example::</span>

<span class="sd">        [(10, 10, 40, 50), (120, 30, 160, 70), (130, 140, 200, 260)]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;img&quot; must be image data from opencv&#39;</span><span class="p">)</span> 

    <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">input_frame</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">))</span>
    <span class="n">input_frame</span> <span class="o">=</span> <span class="n">input_frame</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">input_frame</span> <span class="o">=</span> <span class="n">input_frame</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_detection_compiled</span><span class="p">([</span><span class="n">input_frame</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">face_output_name</span><span class="p">]</span>

    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">confidence</span> <span class="o">=</span> <span class="n">detection</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># Threshold</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">detection</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">img</span><span class="p">[</span><span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">,</span> <span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
          <span class="k">continue</span>
        <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">items</span></div>

    <span class="c1">#return [(d.left(), d.top(), d.right()-d.left(), d.bottom()-d.top()) for d in self.face_detector(img)]</span>
    <span class="c1">#return self.face_detector.detectMultiScale(cv2.cvtColor(img, cv2.COLOR_BGR2GRAY), 1.1, 5) # [(x,y,w,h), ...]</span>

<div class="viewcode-block" id="Face.detect_face_vis">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.detect_face_vis">[문서]</a>
  <span class="k">def</span> <span class="nf">detect_face_vis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴 box 표시합니다.</span>

<span class="sd">    :param numpy.ndarray img: 이미지 객체</span>
<span class="sd">    :param array item: 얼굴 좌표 (x1,y1,x2,y2) 리스트</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;img&quot; must be image data from opencv&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
      <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">item</span>
      <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="Face.landmark_face">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.landmark_face">[문서]</a>
  <span class="k">def</span> <span class="nf">landmark_face</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴의 랜드마크를 탐색합니다.</span>

<span class="sd">    example::</span>

<span class="sd">      img = camera.read()</span>
<span class="sd">      face.landmark_face(img)</span>

<span class="sd">    :param numpy.ndarray img: 이미지 객체</span>
<span class="sd">    :param array item: 얼굴 좌표 (x1,y1,x2,y2)</span>
<span class="sd">    :returns: 좌표 리스트</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;img&quot; must be image data from opencv&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;item&quot; must be [x1,y1,x2,y2]&#39;</span><span class="p">)</span>

    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">item</span>
    <span class="n">face_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y2</span><span class="p">))</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">shape</span><span class="o">.</span><span class="n">num_parts</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="o">.</span><span class="n">num_parts</span><span class="p">):</span>
      <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">shape</span><span class="o">.</span><span class="n">part</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">.</span><span class="n">part</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coords</span></div>


<div class="viewcode-block" id="Face.landmark_face_vis">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.landmark_face_vis">[문서]</a>
  <span class="k">def</span> <span class="nf">landmark_face_vis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴의 랜드마크를 탐색합니다.</span>

<span class="sd">    example::</span>

<span class="sd">      img = camera.read()</span>
<span class="sd">      face.landmark_face(img)</span>

<span class="sd">    :param numpy.ndarray img: 이미지 객체</span>
<span class="sd">    :param array item: 얼굴 좌표 (x1,y1,x2,y2)</span>
<span class="sd">    :returns: 좌표 리스트</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;img&quot; must be image data from opencv&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
      <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">coord</span>
      <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">putTextPIL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">15</span><span class="p">),</span> <span class="mi">15</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span></div>


<div class="viewcode-block" id="Face.analyze_face">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.analyze_face">[문서]</a>
  <span class="k">def</span> <span class="nf">analyze_face</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴의 나이, 성별, 감정을 추정합니다.</span>

<span class="sd">    example::</span>

<span class="sd">      img = camera.read()</span>
<span class="sd">      items = face.detect_face(img)</span>
<span class="sd">      item = items[0] # item은 items 중 하나</span>
<span class="sd">      face.analyze_face(img, item)</span>

<span class="sd">    :param numpy.ndarray img: 이미지 객체</span>
<span class="sd">    :param numpy.ndarray item: 얼굴의 좌표 (x, y, w, h)</span>
<span class="sd">    :returns: {age: 0~100, gender: Male 또는 Female, emotions: ``neutral``, ``happy``, ``sad``, ``surprise``, ``anger``, box:좌표}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;img&quot; must be image data from opencv&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;item&quot; must be [x1,y1,x2,y2]&#39;</span><span class="p">)</span>

    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">item</span>
    <span class="n">face_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Preprocess face for age/gender</span>
    <span class="n">face_resized_age_gender</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">face_img</span><span class="p">,</span> <span class="p">(</span><span class="mi">62</span><span class="p">,</span> <span class="mi">62</span><span class="p">))</span>  <span class="c1"># 62x62 크기로 조정</span>
    <span class="n">face_input_age_gender</span> <span class="o">=</span> <span class="n">face_resized_age_gender</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">face_input_age_gender</span> <span class="o">=</span> <span class="n">face_input_age_gender</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Age and gender prediction</span>
    <span class="n">age_gender_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">age_gender_compiled</span><span class="p">([</span><span class="n">face_input_age_gender</span><span class="p">])</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">age_gender_result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">age_output_name</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">gender</span> <span class="o">=</span> <span class="s2">&quot;Male&quot;</span> <span class="k">if</span> <span class="n">age_gender_result</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gender_output_name</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="s2">&quot;Female&quot;</span>

    <span class="c1"># Preprocess face for emotion</span>
    <span class="n">face_resized_emotion</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">face_img</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>  <span class="c1"># 64x64 크기로 조정</span>
    <span class="n">face_input_emotion</span> <span class="o">=</span> <span class="n">face_resized_emotion</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">face_input_emotion</span> <span class="o">=</span> <span class="n">face_input_emotion</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    
    <span class="c1"># Emotion prediction</span>
    <span class="n">emotion_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emotion_compiled</span><span class="p">([</span><span class="n">face_input_emotion</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">emotion_output_name</span><span class="p">]</span>
    <span class="n">emotion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">emotions</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">emotion_result</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;age&quot;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">age</span><span class="p">),</span> <span class="s2">&quot;gender&quot;</span><span class="p">:</span><span class="n">gender</span><span class="p">,</span> <span class="s2">&quot;emotion&quot;</span><span class="p">:</span><span class="n">emotion</span><span class="p">,</span> <span class="s2">&quot;box&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)}</span></div>



<div class="viewcode-block" id="Face.analyze_face_vis">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.analyze_face_vis">[문서]</a>
  <span class="k">def</span> <span class="nf">analyze_face_vis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴의 나이, 성별, 감정을 추정합니다.</span>

<span class="sd">    :param numpy.ndarray img: 이미지 객체</span>
<span class="sd">    :param numpy.ndarray item: 얼굴 분석 결과</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;img&quot; must be image data from opencv&#39;</span><span class="p">)</span>

    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;box&#39;</span><span class="p">]</span>
    <span class="n">age</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">emotion</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;emotion&#39;</span><span class="p">]</span>
    <span class="n">putTextPIL</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">age</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">gender</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">emotion</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="o">-</span><span class="mi">30</span><span class="p">),</span> <span class="mi">30</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span></div>



<div class="viewcode-block" id="Face.init_db">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.init_db">[문서]</a>
  <span class="k">def</span> <span class="nf">init_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴 데이터베이스를 초기화합니다.</span>

<span class="sd">    초기화된 데이터베이스는 빈 이중 list ``[[], []]`` 입니다.</span>

<span class="sd">    example::</span>

<span class="sd">      face.init_db()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span></div>


<div class="viewcode-block" id="Face.train_face">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.train_face">[문서]</a>
  <span class="k">def</span> <span class="nf">train_face</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴을 학습하여 얼굴 데이터베이스에 저장합니다.</span>

<span class="sd">    example::</span>

<span class="sd">      img = camera.read()</span>
<span class="sd">      items = face.detect_face(img)</span>
<span class="sd">      item = items[0] # item는 items중 하나</span>
<span class="sd">      face.train_face(img, item, &#39;honggildong&#39;)</span>

<span class="sd">    :param numpy.ndarray img: 이미지 객체</span>

<span class="sd">    :param numpy.ndarray item: 디텍팅한 얼굴의 사각형 좌측상단, 우측하단 포인트 (x1, y1, x2, y2)</span>

<span class="sd">    :param str name: 디텍팅한 얼굴에 붙일 이름</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;img&quot; must be image data from opencv&#39;</span><span class="p">)</span> 

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;item&quot; must be [x,y,w,h]&#39;</span><span class="p">)</span>

    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">item</span>
    <span class="n">face_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y2</span><span class="p">))</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span>
    <span class="n">face_encoding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_encoder</span><span class="o">.</span><span class="n">compute_face_descriptor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_encoding</span><span class="p">)</span></div>

    <span class="c1">#cv2.imwrite(self.data_path+&quot;/{}.jpg&quot;.format(name), img[y+3:y+h-3, x+3:x+w-3]);</span>

<div class="viewcode-block" id="Face.delete_face">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.delete_face">[문서]</a>
  <span class="k">def</span> <span class="nf">delete_face</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    등록된 얼굴을 삭제합니다.</span>

<span class="sd">    example::</span>

<span class="sd">      face.delete_face(&#39;honggildong&#39;)</span>

<span class="sd">    :param str name: 삭제할 얼굴의 이름</span>

<span class="sd">    :returns: ``True`` / ``False``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="c1">#os.remove(self.data_path +&quot;/&quot; + name + &quot;.jpg&quot;)</span>
      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">item</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="Face.recognize">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.recognize">[문서]</a>
  <span class="k">def</span> <span class="nf">recognize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    등록된 얼굴을 인식합니다.</span>

<span class="sd">    example::</span>

<span class="sd">      img = camera.read()</span>
<span class="sd">      items = face.detect_face(img)</span>
<span class="sd">      item = items[0] # item는 items중 하나</span>
<span class="sd">      face.recognize(img, item)</span>

<span class="sd">    :param numpy.ndarray img: 이미지 객체</span>
<span class="sd">    :param numpy.ndarray item: 얼굴의 좌표 (x, y, w, h)</span>

<span class="sd">    :returns: ``{&quot;name&quot;: 이름, &quot;score&quot;: 오차도}``</span>

<span class="sd">      얼굴이 비슷할수록 오차도가 낮게 측정됩니다.</span>

<span class="sd">      오차도가 0.4 이하일 때 동일인으로 판정합니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;img&quot; must be image data from opencv&#39;</span><span class="p">)</span> 

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;item&quot; must be [x,y,w,h]&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">facedb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Guest&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>

    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Guest&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">}</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">item</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y2</span><span class="p">))</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">rect</span><span class="p">)</span>
    <span class="n">face_encoding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_encoder</span><span class="o">.</span><span class="n">compute_face_descriptor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">facedb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">face_encoding</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
      <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">matches</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">matches</span><span class="p">))]</span>
    
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">matches</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">matches</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="Face.get_db">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.get_db">[문서]</a>
  <span class="k">def</span> <span class="nf">get_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    사용 중인 얼굴 데이터베이스를 확인합니다.</span>

<span class="sd">    example::</span>

<span class="sd">      face.get_db()</span>

<span class="sd">    :returns: **facedb** (``list(list, list)`` 타입)</span>

<span class="sd">      example::</span>

<span class="sd">        [</span>
<span class="sd">          [&#39;honggildong&#39;],</span>
<span class="sd">          [array([-0.06423206,  0.12474005,  0.0511112 , -0.05676335, -0.07211345,</span>
<span class="sd">                  -0.03123881, -0.04119622, -0.12800875,  0.11717855, -0.11079554,</span>
<span class="sd">                   0.22952782, -0.02007426, -0.17457265, -0.13562854, -0.04972655,</span>
<span class="sd">                   0.15810637, -0.12785575, -0.16479518, -0.07002968, -0.00208595,</span>
<span class="sd">                   0.169218  ,  0.03144928, -0.01074579,  0.04103286, -0.09245337,</span>
<span class="sd">                  ...</span>
<span class="sd">                  -0.00706697,  0.06025593, -0.0049719 ])]</span>
<span class="sd">        ]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span></div>


<div class="viewcode-block" id="Face.save_db">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.save_db">[문서]</a>
  <span class="k">def</span> <span class="nf">save_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴 데이터베이스를 파일로 저장합니다.</span>

<span class="sd">    example::</span>

<span class="sd">      face.save_db(&#39;/home/pi/facedb&#39;)</span>

<span class="sd">    :param str filename: 저장할 얼굴 데이터베이스 파일의 경로입니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">facedb</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Face.load_db">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.load_db">[문서]</a>
  <span class="k">def</span> <span class="nf">load_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴 데이터베이스 파일을 불러옵니다.</span>

<span class="sd">    example::</span>

<span class="sd">      face.load_db(&#39;/home/pi/facedb&#39;)</span>

<span class="sd">    :param str filename: 불러 올 ``facedb`` 파일의 경로입니다.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">{filename}</span><span class="s1">&quot; does not exist&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span> <span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">facedb</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


  <span class="c1"># face mesh</span>
<div class="viewcode-block" id="Face.calculate_head_orientation">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.calculate_head_orientation">[문서]</a>
  <span class="k">def</span> <span class="nf">calculate_head_orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keypoints</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (내부 함수) 얼굴 랜드마크 데이터를 통해 얼굴 방향 계산</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Keypoints for calculations</span>
    <span class="n">nose_tip</span> <span class="o">=</span> <span class="n">keypoints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">left_nose</span> <span class="o">=</span> <span class="n">keypoints</span><span class="p">[</span><span class="mi">279</span><span class="p">]</span>
    <span class="n">right_nose</span> <span class="o">=</span> <span class="n">keypoints</span><span class="p">[</span><span class="mi">49</span><span class="p">]</span>
      
    <span class="c1"># Calculate midpoint</span>
    <span class="n">midpoint</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">left_nose</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_nose</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">left_nose</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_nose</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">left_nose</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_nose</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Perpendicular point above midpoint</span>
    <span class="n">perpendicular_up</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">midpoint</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
      <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">midpoint</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span>  <span class="c1"># Offset</span>
      <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">midpoint</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># Calculate yaw and turn</span>
    <span class="n">yaw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_angle_between_lines</span><span class="p">(</span><span class="n">midpoint</span><span class="p">,</span> <span class="n">nose_tip</span><span class="p">,</span> <span class="n">perpendicular_up</span><span class="p">)</span>
    <span class="n">turn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_angle_between_lines</span><span class="p">(</span><span class="n">midpoint</span><span class="p">,</span> <span class="n">right_nose</span><span class="p">,</span> <span class="n">nose_tip</span><span class="p">)</span>

    <span class="c1"># Debug yaw and turn</span>
    <span class="c1"># print(f&quot;[DEBUG] Yaw: {yaw:.2f}, Turn: {turn:.2f}&quot;)</span>

    <span class="c1"># Determine direction based on angles</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">yaw</span> <span class="o">&gt;</span> <span class="mi">105</span><span class="p">:</span>  <span class="c1"># Adjusted threshold</span>
      <span class="n">direction</span> <span class="o">+=</span> <span class="s2">&quot;B&quot;</span>  <span class="c1"># Bottom</span>
    <span class="k">elif</span> <span class="n">yaw</span> <span class="o">&lt;</span> <span class="mi">75</span><span class="p">:</span>  <span class="c1"># Adjusted threshold</span>
      <span class="n">direction</span> <span class="o">+=</span> <span class="s2">&quot;T&quot;</span>  <span class="c1"># Top</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">direction</span> <span class="o">+=</span> <span class="s2">&quot;C&quot;</span>  <span class="c1"># Center (vertical)</span>

    <span class="k">if</span> <span class="n">turn</span> <span class="o">&gt;</span> <span class="mi">93</span><span class="p">:</span>  <span class="c1"># Adjusted threshold</span>
      <span class="n">direction</span> <span class="o">+=</span> <span class="s2">&quot;R&quot;</span>  <span class="c1"># Right</span>
    <span class="k">elif</span> <span class="n">turn</span> <span class="o">&lt;</span> <span class="mi">87</span><span class="p">:</span>  <span class="c1"># Adjusted threshold</span>
      <span class="n">direction</span> <span class="o">+=</span> <span class="s2">&quot;L&quot;</span>  <span class="c1"># Left</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">direction</span> <span class="o">+=</span> <span class="s2">&quot;C&quot;</span>  <span class="c1"># Center (horizontal)</span>

    <span class="k">return</span> <span class="n">direction</span></div>


<div class="viewcode-block" id="Face.get_angle_between_lines">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.get_angle_between_lines">[문서]</a>
  <span class="k">def</span> <span class="nf">get_angle_between_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">point1</span><span class="p">,</span> <span class="n">point2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate angle between two lines defined by three points.&quot;&quot;&quot;</span>
    <span class="c1"># Vector 1: start -&gt; point1</span>
    <span class="n">vector1</span> <span class="o">=</span> <span class="p">(</span><span class="n">point1</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">point1</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">point1</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">])</span>
    <span class="c1"># Vector 2: start -&gt; point2</span>
    <span class="n">vector2</span> <span class="o">=</span> <span class="p">(</span><span class="n">point2</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">point2</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">point2</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">])</span>

    <span class="c1"># Dot product and magnitude</span>
    <span class="n">dot_product</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v2</span> <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vector1</span><span class="p">,</span> <span class="n">vector2</span><span class="p">))</span>
    <span class="n">magnitude1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vector1</span><span class="p">))</span>
    <span class="n">magnitude2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vector2</span><span class="p">))</span>

    <span class="c1"># Calculate angle in degrees</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">dot_product</span> <span class="o">/</span> <span class="p">(</span><span class="n">magnitude1</span> <span class="o">*</span> <span class="n">magnitude2</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">angle</span></div>


<div class="viewcode-block" id="Face.detect_mesh_vis">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.detect_mesh_vis">[문서]</a>
  <span class="k">def</span> <span class="nf">detect_mesh_vis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draw connections between landmarks based on Mediapipe&#39;s face mesh.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
      <span class="n">face_landmarks</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;landmark&#39;</span><span class="p">]</span>
      <span class="n">distance</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>
      <span class="n">direction</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span>

      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">face_landmarks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">solutions</span><span class="o">.</span><span class="n">face_mesh</span><span class="o">.</span><span class="n">FACEMESH_TESSELATION</span>
        <span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
          <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">face_landmarks</span><span class="p">[</span><span class="n">start</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">image_width</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">face_landmarks</span><span class="p">[</span><span class="n">start</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">image_height</span><span class="p">)</span>
          <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">face_landmarks</span><span class="p">[</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">image_width</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">face_landmarks</span><span class="p">[</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">image_height</span><span class="p">)</span>
          <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">face_landmarks</span><span class="p">[</span><span class="mi">103</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">image_width</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">face_landmarks</span><span class="p">[</span><span class="mi">103</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">image_height</span><span class="p">)</span>
        <span class="n">putTextPIL</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">distance</span><span class="si">}</span><span class="s1">cm/</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">30</span><span class="p">),</span> <span class="mi">30</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">))</span></div>


<div class="viewcode-block" id="Face.detect_mesh">
<a class="viewcode-back" href="../../libraries/vision_face.html#openpibo.vision_face.Face.detect_mesh">[문서]</a>
  <span class="k">def</span> <span class="nf">detect_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detect mesh and return distance, direction, and image with landmarks.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    얼굴의 랜드마크를 인식하고, 거리, 방향을 추정합니다</span>

<span class="sd">    :param numpy.ndarray img: 이미지 객체</span>

<span class="sd">    :returns: {얼굴의 거리, 방향, 랜드마크}의 리스트 (얼굴 2개까지 인식) </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert the image from BGR to RGB</span>
    <span class="n">rgb_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="n">mp_image</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">image_format</span><span class="o">=</span><span class="n">mp</span><span class="o">.</span><span class="n">ImageFormat</span><span class="o">.</span><span class="n">SRGB</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">rgb_image</span><span class="p">)</span>

    <span class="n">mesh_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Perform inference</span>
    <span class="n">mesh_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_detector</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">mp_image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mesh_result</span> <span class="ow">and</span> <span class="n">mesh_result</span><span class="o">.</span><span class="n">face_landmarks</span><span class="p">:</span>
      <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span>
      <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">face_landmarks</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mesh_result</span><span class="o">.</span><span class="n">face_landmarks</span><span class="p">):</span>
        <span class="c1"># Convert landmarks to a dictionary-like structure</span>
        <span class="n">keypoints</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">lm</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">lm</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">lm</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">w</span><span class="p">}</span> <span class="k">for</span> <span class="n">lm</span> <span class="ow">in</span> <span class="n">face_landmarks</span><span class="p">]</span>

        <span class="c1"># Calculate head orientation</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_head_orientation</span><span class="p">(</span><span class="n">keypoints</span><span class="p">)</span>

        <span class="c1"># Calculate iris-based distance</span>
        <span class="n">left_iris_idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">474</span><span class="p">,</span> <span class="mi">475</span><span class="p">,</span> <span class="mi">476</span><span class="p">,</span> <span class="mi">477</span><span class="p">]</span>
        <span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">left_iris_idx</span><span class="p">:</span>
          <span class="n">x_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_landmarks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
          <span class="n">y_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_landmarks</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>

        <span class="n">iris_diameter_px</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_vals</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_vals</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">iris_diameter_px</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">distance_mm</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FOCAL_LENGTH_MM</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">IRIS_REAL_DIAMETER_MM</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">iris_diameter_px</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">PIXEL_PITCH_MM</span><span class="p">)</span>
          <span class="n">distance_cm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">distance_mm</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span>

        <span class="n">mesh_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;distance&quot;</span><span class="p">:</span><span class="n">distance_cm</span><span class="p">,</span> <span class="s2">&quot;direction&quot;</span><span class="p">:</span><span class="n">direction</span><span class="p">,</span> <span class="s2">&quot;landmark&quot;</span><span class="p">:</span> <span class="n">face_landmarks</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">mesh_data</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 THEMAKER. All rights reserved. openpibo-python-0.9.3.2.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>